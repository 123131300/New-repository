<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Mouse & Cheese ‚Äî Neon v4.6</title>
<style>
:root{
  --bg:#0f1620; --card:#121b26; --text:#e9eef6; --text-dim:#a9b4c2; --primary:#21b2ff; --ok:#2dd4bf; --warn:#f59e0b; --danger:#ef4444; --chip:rgba(255,255,255,.06);
  --ring:#6ea8ff; --ring-bg:#263349; --shadow:0 8px 28px rgba(0,0,0,.35);
}
[data-theme="light"]{
  --bg:#eef2f6; --card:#ffffff; --text:#0c1220; --text-dim:#5b6574; --primary:#0ea5e9; --ok:#0db39e; --warn:#b7791f; --danger:#dc2626; --chip:rgba(0,0,0,.06);
  --ring:#7c3aed; --ring-bg:#e6e9f2; --shadow:0 10px 30px rgba(12,18,32,.12);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; background:var(--bg); color:var(--text)}
.container{max-width:960px;margin:0 auto;padding:20px 16px 48px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:4px 0 12px}
.brand{display:flex;align-items:center;gap:8px;font-weight:800;font-size:18px}
.brand .logo{font-size:22px}
.header-actions{display:flex;gap:8px;align-items:center}
.btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:600;background:var(--primary);color:#fff;box-shadow:var(--shadow);cursor:pointer}
.btn:active{transform:translateY(1px)}
.btn-ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.1)}
.btn-ghost:where([data-theme="light"] *), [data-theme="light"] .btn-ghost{border-color:rgba(12,18,32,.12)}
.btn-ok{background:var(--ok);}
.btn-warn{background:var(--warn)}
.btn-danger{background:var(--danger)}
.card{background:var(--card);border-radius:18px;padding:16px;box-shadow:var(--shadow)}
.grid{display:grid;gap:14px}
.menu-row{display:grid;gap:14px}
@media(min-width:640px){.menu-row{grid-template-columns:1fr 1fr}}
.title-xl{font-weight:900;font-size:clamp(22px,5vw,32px);letter-spacing:-.01em;margin:6px 0 14px}
.title-lg{font-weight:800;font-size:clamp(18px,4.2vw,26px);margin:0 0 10px}
.subtitle{opacity:.8;font-size:clamp(12px,3.4vw,14px);margin:0}
.stat-wrap{display:grid;gap:14px}
@media(min-width:640px){.stat-wrap{grid-template-columns:1fr 1fr}}
.stat-card{display:flex;align-items:center;gap:16px}
.stat-ring{position:relative;width:160px;aspect-ratio:1/1;border-radius:50%;background:
  radial-gradient(closest-side,transparent 78%, var(--ring-bg) 78% 100%),
  conic-gradient(var(--ring) var(--p,10%), transparent 0)}
.stat-ring .center{position:absolute;inset:10px;border-radius:50%;background:var(--card);display:flex;align-items:center;justify-content:center;flex-direction:column}
.stat-ring .big{font-size:clamp(28px,10vw,48px);font-weight:900}
.stat-ring .label{font-size:clamp(12px,3.5vw,16px);opacity:.8;margin-top:-4px}
.kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.kpi .cell{background:var(--card);border-radius:14px;padding:12px;text-align:center}
.kpi .num{font-weight:900;font-size:clamp(18px,5.4vw,22px)}
.kpi .cap{opacity:.8;font-size:12px}
.menu-row .item{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:14px 16px;border-radius:16px;background:var(--card);box-shadow:var(--shadow)}
.menu-row .left{display:flex;align-items:center;gap:12px}
.menu-row .emoji{font-size:22px}
.menu-row .card-title{font-size:clamp(16px,4vw,22px);font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.menu-row .card-sub{opacity:.7;font-size:clamp(12px,3.4vw,14px)}
.menu-row .chipbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.chip{padding:4px 8px;border-radius:999px;background:var(--chip);font-size:12px;opacity:.9}
.hidden{display:none!important}
.view{display:none}
.view.active{display:block}
.center{display:flex;align-items:center;justify-content:center}
.actions-inline{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
.word{font-size:clamp(42px,12vw,64px);font-weight:900;letter-spacing:-.02em}
.pron-hint{font-size:clamp(14px,3.6vw,16px);opacity:.8;margin-bottom:8px}
.pill{padding:.25rem .6rem;border-radius:999px;background:var(--chip);font-size:12px}
/* game */
.game-wrap{display:flex;flex-direction:column;gap:12px}
.game-instructions{text-align:center;font-size:clamp(12px,3.4vw,14px);opacity:.8}
canvas{touch-action:none;border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.04))}
/* quiz buttons */
.answer{width:100%;padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:var(--card);color:var(--text);font-weight:700}
[data-theme="light"] .answer{border-color:rgba(12,18,32,.12)}
.answer.ok{border-color:var(--ok)}
.answer.bad{border-color:var(--danger)}
.footer-note{opacity:.6;margin-top:16px;text-align:center;font-size:12px}
</style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="brand"><span class="logo">üê≠</span><span>Mouse & Cheese</span></div>
      <div class="header-actions">
        <button class="btn-ghost" id="btnTheme">–¢–µ–º–∞</button>
        <button class="btn-ghost" id="btnSettings">–ú–µ–Ω—é</button>
      </div>
    </header>

    <!-- MENU VIEW -->
    <section id="view-menu" class="view active">
      <h1 class="title-xl">–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h1>
      <div class="grid">
        <div class="card">
          <div class="stat-wrap">
            <div class="stat-card">
              <div class="stat-ring" id="ring" style="--p:5%">
                <div class="center">
                  <div class="big" id="ringNum">1</div>
                  <div class="label">–°–µ–≥–æ–¥–Ω—è</div>
                </div>
              </div>
              <div>
                <h2 class="title-lg">–¶–µ–ª—å: <span id="goal">20</span>/–¥–µ–Ω—å</h2>
                <p class="subtitle">–î–≤–∏–≥–∞–π—Å—è –∫ —Ü–µ–ª–∏ ‚Äî –∑–∞–Ω–∏–º–∞–π—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.</p>
                <div class="kpi">
                  <div class="cell"><div class="num" id="statCards">0</div><div class="cap">–ö–∞—Ä—Ç–æ—á–∫–∏</div></div>
                  <div class="cell"><div class="num" id="statQuiz">0</div><div class="cap">–í–∏–∫—Ç–æ—Ä–∏–Ω–∞</div></div>
                  <div class="cell"><div class="num" id="statCheese">0</div><div class="cap">–°—ã—Ä</div></div>
                  <div class="cell"><div class="num" id="statPron">0</div><div class="cap">–ü—Ä–æ–∏–∑–Ω.</div></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="menu-row">
          <div class="item">
            <div class="left"><div class="emoji">üß†</div>
              <div>
                <div class="card-title">–í–∏–∫—Ç–æ—Ä–∏–Ω–∞</div>
                <div class="card-sub">–í—ã–±–µ—Ä–∏ –≤–µ—Ä–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥</div>
                <div class="chipbar"><span class="chip">–∑–∞ —Å–µ–≥–æ–¥–Ω—è: <b id="today-quiz">0</b></span> <span class="chip">–≤—Å–µ–≥–æ: <b id="total-quiz">0</b></span></div>
              </div>
            </div>
            <button class="btn" onclick="navigate('quiz')">–û—Ç–∫—Ä—ã—Ç—å ‚Üí</button>
          </div>

          <div class="item">
            <div class="left"><div class="emoji">üÉè</div>
              <div>
                <div class="card-title">–ö–∞—Ä—Ç–æ—á–∫–∏</div>
                <div class="card-sub">EN ‚áÑ RU. ¬´–ó–Ω–∞—é¬ª –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ –∏–∑—É—á–µ–Ω–Ω—ã–µ</div>
                <div class="chipbar"><span class="chip">–∑–∞ —Å–µ–≥–æ–¥–Ω—è: <b id="today-cards">0</b></span> <span class="chip">–∏–∑—É—á–µ–Ω–æ: <b id="total-known">0</b></span></div>
              </div>
            </div>
            <button class="btn" onclick="navigate('cards')">–û—Ç–∫—Ä—ã—Ç—å ‚Üí</button>
          </div>

          <div class="item">
            <div class="left"><div class="emoji">üéÆ</div>
              <div>
                <div class="card-title">–ò–≥—Ä–∞</div>
                <div class="card-sub">–°—ä–µ—à—å —Å—ã—Ä ‚Äî ¬´–±–∏–ø¬ª + —Å–ª–æ–≤–æ</div>
              </div>
            </div>
            <button class="btn" onclick="navigate('game')">–û—Ç–∫—Ä—ã—Ç—å ‚Üí</button>
          </div>

          <div class="item">
            <div class="left"><div class="emoji">üéôÔ∏è</div>
              <div>
                <div class="card-title">–ü—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ</div>
                <div class="card-sub">–°–∫–∞–∂–∏ —Å–ª–æ–≤–æ –∫–∞–∫ –º–æ–∂–Ω–æ –±–ª–∏–∂–µ –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—É</div>
                <div class="chipbar"><span class="chip">–¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: <b id="micState">‚Äî</b></span></div>
              </div>
            </div>
            <button class="btn" onclick="navigate('pron')">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å ‚Üí</button>
          </div>
        </div>
      </div>
      <div class="footer-note">v4.6 ¬∑ Light/Dark ¬∑ —Ç–∞—á-—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ¬∑ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</div>
    </section>

    <!-- QUIZ VIEW -->
    <section id="view-quiz" class="view">
      <div class="card">
        <h2 class="title-lg">–í–∏–∫—Ç–æ—Ä–∏–Ω–∞ ‚Äî –≤—ã–±–µ—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥</h2>
        <div class="word" id="quizPrompt">cheese</div>
        <div class="grid" style="grid-template-columns:1fr 1fr;margin-top:12px;gap:12px" id="quizOptions"></div>
      </div>
    </section>

    <!-- CARDS VIEW -->
    <section id="view-cards" class="view">
      <div class="card">
        <p class="pron-hint">–ù–∞–∂–º–∏ ¬´–ü–æ–∫–∞–∑–∞—Ç—å RU¬ª</p>
        <div class="word" id="cardWord">cheese</div>
        <div class="actions-inline" style="margin-top:14px">
          <button class="btn" id="btnShowRU">–ü–æ–∫–∞–∑–∞—Ç—å RU</button>
          <button class="btn" id="btnCardTTS">–û–∑–≤—É—á–∏—Ç—å</button>
          <button class="btn btn-ok" id="btnKnow">–ó–Ω–∞—é</button>
          <button class="btn btn-ghost" id="btnNextCard">–î–∞–ª—å—à–µ</button>
        </div>
      </div>
    </section>

    <!-- GAME VIEW -->
    <section id="view-game" class="view">
      <div class="card game-wrap">
        <h2 class="title-lg">–ú—ã—à—å & –°—ã—Ä</h2>
        <canvas id="gameCanvas" width="660" height="420"></canvas>
        <p class="game-instructions">–°–≤–∞–π–ø–∞–π –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –¢–∞–ø ‚Äî —à–∞–≥ –∫ —Å—ã—Ä—É. –°—ä–µ—à—å —Å—ã—Ä ‚Äî ¬´–±–∏–ø¬ª –∏ —Å–ª–æ–≤–æ.</p>
      </div>
    </section>

    <!-- PRONUNCIATION VIEW -->
    <section id="view-pron" class="view">
      <div class="card">
        <p class="pron-hint">–ü—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ ‚Ä¢ —Å–∫–∞–∂–∏ —Å–ª–æ–≤–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ—Ö–æ–∂–µ –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—É</p>
        <div class="word" id="pronWord">cheese</div>
        <div class="grid" style="grid-template-columns:1fr 1fr;margin-top:12px">
          <button class="btn" id="btnListen">–°–ª—É—à–∞—Ç—å</button>
          <button class="btn" id="btnSay">–°–∫–∞–∑–∞—Ç—å (–±—Ä–∞—É–∑–µ—Ä)</button>
          <button class="btn btn-ghost" id="btnPronNext" style="grid-column:1/-1">–î–∞–ª—å—à–µ</button>
        </div>
        <div class="grid" style="margin-top:12px">
          <div class="pill" id="micInfo">–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ‚Äî</div>
          <div class="grid" style="grid-template-columns:1fr auto;gap:10px">
            <input id="fallbackInput" class="card" placeholder="–§–æ–ª–ª–±—ç–∫: –Ω–∞–ø–µ—á–∞—Ç–∞–π –∞–Ω–≥–ª."/>
            <button class="btn" id="btnCheck">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
          </div>
          <div class="pill" id="score">–°–æ–≤–ø–∞–¥–µ–Ω–∏–µ: 0%</div>
        </div>
      </div>
    </section>

  </div>

<script>
// --- DATA -----------------------------------------------------------------
const PAIRS = [
  {en:'cheese', ru:'—Å—ã—Ä'},{en:'bread', ru:'—Ö–ª–µ–±'},{en:'water', ru:'–≤–æ–¥–∞'},
  {en:'friend', ru:'–¥—Ä—É–≥'},{en:'computer', ru:'–∫–æ–º–ø—å—é—Ç–µ—Ä'},{en:'child', ru:'—Ä–µ–±—ë–Ω–æ–∫'},
  {en:'write', ru:'–ø–∏—Å–∞—Ç—å'},{en:'speak', ru:'–≥–æ–≤–æ—Ä–∏—Ç—å'},{en:'ticket', ru:'–±–∏–ª–µ—Ç'},
];

// --- STATE / STORAGE -------------------------------------------------------
const S = JSON.parse(localStorage.getItem('mc_state_v46')||'{}');
S.stats ||= {today:0, quiz:0, cards:0, cheese:0, pron:0, known:[]};
S.theme ||= (matchMedia('(prefers-color-scheme: light)').matches?'light':'dark');

function save(){localStorage.setItem('mc_state_v46', JSON.stringify(S));}

// --- ROUTER ---------------------------------------------------------------
function show(id){ document.querySelectorAll('.view').forEach(v=>v.classList.toggle('active', v.id===id)); }
function navigate(name){
  if(name==='menu'){renderMenu(); show('view-menu');}
  if(name==='quiz'){newQuiz(); show('view-quiz');}
  if(name==='cards'){renderCard(); show('view-cards');}
  if(name==='game'){resizeGame(); show('view-game');}
  if(name==='pron'){newPron(); show('view-pron');}
}

// --- THEME ----------------------------------------------------------------
function applyTheme(){
  document.documentElement.setAttribute('data-theme', S.theme);
}
function toggleTheme(){ S.theme = (S.theme==='light'?'dark':'light'); applyTheme(); save(); }
applyTheme();

// header buttons
btnTheme.addEventListener('click',toggleTheme);
btnSettings.addEventListener('click',()=>navigate('menu'));

// --- MENU RENDER ----------------------------------------------------------
function renderMenu(){
  // ring percent ‚Äî today/S.goal
  const today = S.stats.today||0; const goal = 20; 
  document.getElementById('ring').style.setProperty('--p', Math.min(100, Math.round((today/goal)*100))+'%');
  document.getElementById('ringNum').textContent = today||1;
  document.getElementById('goal').textContent = goal;
  statCards.textContent = S.stats.cards||0; statQuiz.textContent = S.stats.quiz||0; statCheese.textContent = S.stats.cheese||0; statPron.textContent = S.stats.pron||0;
  today-quiz && (document.getElementById('today-quiz').textContent = S.stats.quiz||0);
  document.getElementById('total-quiz').textContent = (S.stats.quiz||0);
  document.getElementById('today-cards').textContent = (S.stats.cards||0);
  document.getElementById('total-known').textContent = (S.stats.known?.length||0);
}
renderMenu();

// --- QUIZ -----------------------------------------------------------------
let currentQuiz = null;
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }
function makeQuizQuestion(pairs, locale='ru'){
  const idx = Math.floor(Math.random()*pairs.length);
  const q = pairs[idx];
  const answer = (locale==='ru') ? q.ru : q.en;
  const pool = pairs.filter((_,i)=>i!==idx).map(p=> (locale==='ru'?p.ru:p.en));
  shuffle(pool);
  const distractors=[]; for(const v of pool){ if(distractors.length===3) break; if(v && v!==answer && !distractors.includes(v)) distractors.push(v); }
  while(distractors.length<3) distractors.push(answer+' ‚óè');
  const options = shuffle([answer, ...distractors]).slice(0,4);
  return { prompt:(locale==='ru')?q.en:q.ru, answer, options, source:q };
}
function newQuiz(){
  currentQuiz = makeQuizQuestion(PAIRS,'ru');
  quizPrompt.textContent = currentQuiz.prompt;
  quizOptions.innerHTML='';
  currentQuiz.options.forEach(opt=>{
    const b=document.createElement('button'); b.className='answer'; b.textContent=opt; b.onclick=()=>pickQuiz(b, opt);
    quizOptions.appendChild(b);
  })
}
function pickQuiz(btn, val){
  const ok = (val===currentQuiz.answer);
  btn.classList.add(ok?'ok':'bad');
  Array.from(quizOptions.children).forEach(ch=>ch.disabled=true);
  setTimeout(()=>{ S.stats.quiz=(S.stats.quiz||0)+1; S.stats.today=(S.stats.today||0)+1; save(); newQuiz(); }, 700);
}

// --- CARDS ----------------------------------------------------------------
let cardIndex = 0; 
function renderCard(){ const p = PAIRS[cardIndex%PAIRS.length]; cardWord.textContent=p.en; }
btnShowRU.onclick = ()=>{ const p=PAIRS[cardIndex%PAIRS.length]; alert(p.en+' ‚Äî '+p.ru); };
btnCardTTS.onclick = ()=>{ const p=PAIRS[cardIndex%PAIRS.length]; speakWord(p.en,1.0); };
btnKnow.onclick = ()=>{ const p=PAIRS[cardIndex%PAIRS.length]; if(!S.stats.known.includes(p.en)) S.stats.known.push(p.en); S.stats.cards=(S.stats.cards||0)+1; S.stats.today=(S.stats.today||0)+1; save(); nextCard(); };
btnNextCard.onclick = ()=> nextCard();
function nextCard(){ cardIndex=(cardIndex+1)%PAIRS.length; renderCard(); }

// --- GAME -----------------------------------------------------------------
const EMOJI = { mouse:'üê≠', cheese:'üßÄ' };
const game = { grid:18, cols:14, rows:10, mouse:{x:2,y:2}, cheese:{x:8,y:4} };
const ctx = gameCanvas.getContext('2d');
function resizeGame(){
  const w = gameCanvas.clientWidth || 660; const h = Math.round(w*0.64);
  gameCanvas.width=w; gameCanvas.height=h; drawGame();
}
window.addEventListener('resize', resizeGame, {passive:true});
function drawGame(){
  const w=gameCanvas.width,h=gameCanvas.height; ctx.clearRect(0,0,w,h);
  const cell = Math.min(w/game.cols, h/game.rows);
  ctx.font = `${Math.floor(cell*0.9)}px system-ui, Apple Color Emoji, Segoe UI Emoji`;
  ctx.textAlign='center'; ctx.textBaseline='middle';
  // cheese
  ctx.fillText(EMOJI.cheese,(game.cheese.x+0.5)*cell,(game.cheese.y+0.5)*cell);
  ctx.fillText(EMOJI.mouse,(game.mouse.x+0.5)*cell,(game.mouse.y+0.5)*cell);
}
function stepTowardCheese(){
  const dx=game.cheese.x-game.mouse.x, dy=game.cheese.y-game.mouse.y;
  if(Math.abs(dx)>Math.abs(dy)) game.mouse.x+=Math.sign(dx); else game.mouse.y+=Math.sign(dy);
  clampMouse(); checkEat(); drawGame();
}
function clampMouse(){ game.mouse.x=Math.max(0,Math.min(game.cols-1,game.mouse.x)); game.mouse.y=Math.max(0,Math.min(game.rows-1,game.mouse.y)); }
function checkEat(){
  if(game.mouse.x===game.cheese.x && game.mouse.y===game.cheese.y){
    beep(); const p=PAIRS[Math.floor(Math.random()*PAIRS.length)]; speakWord(p.en,1.0);
    S.stats.cheese=(S.stats.cheese||0)+1; S.stats.today=(S.stats.today||0)+1; save();
    game.cheese={x:Math.floor(Math.random()*game.cols), y:Math.floor(Math.random()*game.rows)};
  }
}
let touchStart=null;
gameCanvas.addEventListener('touchstart',e=>{ const t=e.changedTouches[0]; touchStart={x:t.clientX,y:t.clientY}; },{passive:true});
gameCanvas.addEventListener('touchend',e=>{
  if(!touchStart) return; const t=e.changedTouches[0]; const dx=t.clientX-touchStart.x, dy=t.clientY-touchStart.y; const adx=Math.abs(dx), ady=Math.abs(dy);
  if(Math.max(adx,ady)<24){ stepTowardCheese(); }
  else { if(adx>ady) game.mouse.x+=Math.sign(dx); else game.mouse.y+=Math.sign(dy); clampMouse(); checkEat(); drawGame(); }
  touchStart=null;
});
resizeGame(); drawGame();

// simple beep
function beep(){ try{ const ac=new (window.AudioContext||window.webkitAudioContext)(); const o=ac.createOscillator(); const g=ac.createGain(); o.connect(g); g.connect(ac.destination); o.frequency.value=880; o.start(); g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+0.12); setTimeout(()=>ac.close(),180);}catch(e){} }

// --- PRONUNCIATION --------------------------------------------------------
let currentVoice=null, currentPronIndex=0;
function pickVoice(locale='en'){ const list=speechSynthesis.getVoices(); return list.find(v=>v.lang?.toLowerCase().startsWith('en')) || list[0] || null; }
speechSynthesis.onvoiceschanged=()=>{ currentVoice=pickVoice('en'); };
function speakWord(text, rate=1.0){ try{speechSynthesis.cancel()}catch(e){}; const u=new SpeechSynthesisUtterance(text); u.rate=rate; u.lang=(currentVoice?.lang)||'en-US'; if(currentVoice) u.voice=currentVoice; speechSynthesis.speak(u); }

function newPron(){ const p=PAIRS[currentPronIndex%PAIRS.length]; pronWord.textContent=p.en; score.textContent='–°–æ–≤–ø–∞–¥–µ–Ω–∏–µ: 0%'; }
btnListen.onclick=()=>{ const p=PAIRS[currentPronIndex%PAIRS.length]; speakWord(p.en,1.0) };
btnPronNext.onclick=()=>{ currentPronIndex=(currentPronIndex+1)%PAIRS.length; newPron(); };

// STT (–±—Ä–∞—É–∑–µ—Ä) ‚Äî –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
let recognizer=null; let micAllowed=false;
if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition; recognizer=new SR(); recognizer.lang='en-US'; recognizer.interimResults=false; recognizer.maxAlternatives=1;
  recognizer.onresult=(e)=>{ const said=e.results[0][0].transcript||''; gradePronounce(said, PAIRS[currentPronIndex%PAIRS.length].en); };
  recognizer.onerror=(e)=>{ micInfo.textContent='–û—à–∏–±–∫–∞: '+e.error; };
  micState.textContent='–≤–æ–∑–º–æ–∂–Ω–æ';
}else{ micState.textContent='–Ω–µ—Ç API'; }

btnSay.onclick=()=>{ if(!recognizer){ micInfo.textContent='API —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'; return; } try{ recognizer.start(); micInfo.textContent='—Å–ª—É—à–∞—é...'; }catch(e){} };
btnCheck.onclick=()=>{ const said=fallbackInput.value||''; gradePronounce(said, PAIRS[currentPronIndex%PAIRS.length].en); };

function similarity(a,b){ a=(a||'').trim().toLowerCase(); b=(b||'').trim().toLowerCase(); if(!a||!b) return 0; const d=levenshtein(a,b); const maxLen=Math.max(a.length,b.length); return (maxLen===0)?1:(1-d/maxLen); }
function levenshtein(a,b){ const m=a.length,n=b.length; const dp=Array.from({length:m+1},()=>Array(n+1).fill(0)); for(let i=0;i<=m;i++) dp[i][0]=i; for(let j=0;j<=n;j++) dp[0][j]=j; for(let i=1;i<=m;i++){ for(let j=1;j<=n;j++){ const cost=(a[i-1]===b[j-1])?0:1; dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost); } } return dp[m][n]; }
function gradePronounce(recognized,target){ const s=Math.round(similarity(recognized,target)*100); score.textContent='–°–æ–≤–ø–∞–¥–µ–Ω–∏–µ: '+s+'%'; S.stats.pron=(S.stats.pron||0)+1; S.stats.today=(S.stats.today||0)+1; save(); }

// expose for debug
window.navigate=navigate;
</script>
</body>
</html>
