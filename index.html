<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>Mouse & Cheese ‚Äî Neon</title>
<style>
  :root{
    --bg:#0f1620;        /* dark */
    --panel:#151e29;
    --panel-2:#0b1119;
    --text:#eaf1ff;
    --muted:#9fb3d1;
    --brand:#3ec7ff;
    --accent:#7b5cff;
    --ok:#29d884;
    --err:#ff5b6e;
    --ring:rgba(126, 143, 171, .2);
    --card:#121a24;
    --shadow: 0 8px 30px rgba(0,0,0,.3);
  }
  [data-theme="light"]{
    --bg:#f5f7fb;        /* light */
    --panel:#ffffff;
    --panel-2:#eef3fb;
    --text:#0a1628;
    --muted:#516683;
    --brand:#0077ff;
    --accent:#7b5cff;
    --ok:#0bb070;
    --err:#e0344b;
    --ring:rgba(10, 22, 40, .08);
    --card:#ffffff;
    --shadow: 0 8px 26px rgba(10,22,40,.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%;}
  body{
    margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; 
  }
  .wrap{min-height:100svh; display:flex; flex-direction:column; padding-bottom: max(env(safe-area-inset-bottom),16px);}
  header{
    position:sticky; top:0; z-index:5; background:linear-gradient(to bottom, var(--bg), color-mix(in oklab, var(--bg), transparent 20%));
    padding: max(8px, env(safe-area-inset-top)) 12px 8px; border-bottom:1px solid var(--ring);
  }
  .row{display:flex; align-items:center; gap:12px; justify-content:space-between; max-width: 720px; margin:0 auto}
  .brand{display:flex; align-items:center; gap:8px; font-weight:800; letter-spacing:.3px}
  .brand .emoji{font-size:20px}
  .toolbar{display:flex; gap:8px}
  .btn{appearance:none; border:0; border-radius:14px; background:var(--panel); color:var(--text); padding:8px 12px; font-weight:600; box-shadow: var(--shadow); border:1px solid var(--ring);} 
  .btn.ghost{background:transparent}
  .btn.primary{background:linear-gradient(135deg, var(--brand), var(--accent)); color:white;}
  .btn.round{border-radius:10px}
  .container{max-width:720px; margin:0 auto; padding: 12px; flex:1 1 auto; width:100%}
  .grid{display:grid; gap:12px}
  .card{background:var(--card); border:1px solid var(--ring); border-radius:18px; box-shadow:var(--shadow); padding:16px}
  .title{font-weight:800; font-size: clamp(22px, 3.5vw, 28px); letter-spacing:.3px}
  .muted{color:var(--muted)}
  .stat-ring{display:flex; align-items:center; gap:16px}
  .ring{position:relative; width:116px; height:116px; border-radius:60px; background:conic-gradient(var(--brand) var(--p), var(--ring) 0);
        display:grid; place-items:center; box-shadow:inset 0 0 0 12px var(--panel-2), var(--shadow);}
  .ring .day{font-size:40px; font-weight:800}
  .subs{display:grid; grid-template-columns:repeat(4,1fr); gap:8px}
  .counter{background:var(--panel); padding:10px; border-radius:14px; text-align:center; border:1px solid var(--ring)}
  .counter .n{font-size:22px; font-weight:800}
  .list .item{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 14px; border-radius:14px; background:var(--panel); border:1px solid var(--ring)}
  .left{display:flex; align-items:center; gap:10px}
  .h3{font-size:18px; font-weight:800}
  .right .btn{padding:10px 16px}
  .badge{display:inline-flex; align-items:center; gap:6px; padding: 4px 8px; border-radius:999px; background:var(--panel); border:1px solid var(--ring);}

  /* views */
  .view{display:none}
  .view.active{display:block}
  .section-title{font-weight:800; font-size: clamp(20px, 4vw, 28px); margin:4px 0 12px}
  .word{font-weight:900; font-size: clamp(40px, 14vw, 64px); letter-spacing:.5px}
  .actions{display:flex; flex-wrap:wrap; gap:8px}
  .actions .btn{flex:1 1 48%}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}

  /* game */
  #board{ width:100%; height:58svh; background:var(--panel); border:1px solid var(--ring); border-radius:18px; overflow:hidden; box-shadow: var(--shadow)}
  canvas{touch-action:none;}
  .hint{padding:12px 0 4px; color:var(--muted)}

  /* quiz */
  .quiz-opts{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .opt{padding:14px; border-radius:14px; text-align:center; background:var(--panel); border:1px solid var(--ring); font-weight:700}
  .opt.ok{outline:3px solid var(--ok)}
  .opt.bad{outline:3px solid var(--err)}

  footer{padding:12px; text-align:center; color:var(--muted)}

  /* make top area compact on small phones */
  @media (max-width:380px){
    .ring{width:96px; height:96px}
    .ring .day{font-size:34px}
  }
</style>
</head>
<body>
<div class="wrap" id="app">
  <header>
    <div class="row">
      <div class="brand"><span class="emoji">üê≠</span><span class="title">Mouse & Cheese</span></div>
      <div class="toolbar">
        <button class="btn ghost" id="themeBtn">–¢–µ–º–∞</button>
        <button class="btn ghost" data-goto="menu">–ú–µ–Ω—é</button>
      </div>
    </div>
  </header>

  <main class="container">

    <!-- MENU -->
    <section id="view-menu" class="view active grid" aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
      <div class="card">
        <div class="stat-ring">
          <div class="ring" id="todayRing" style="--p: 0deg"><div class="day" id="todayCount">1</div></div>
          <div>
            <div class="h3">–¶–µ–ª—å: <span id="dailyGoal">20</span>/–¥–µ–Ω—å</div>
            <div class="muted">–î–≤–∏–≥–∞–π—Å—è –∫ —Ü–µ–ª–∏ ‚Äî –∑–∞–Ω–∏–º–∞–π—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.</div>
          </div>
        </div>
        <div class="subs" style="margin-top:12px">
          <div class="counter"><div class="n" id="c-cards">0</div><div class="muted">–ö–∞—Ä—Ç–æ—á–∫–∏</div></div>
          <div class="counter"><div class="n" id="c-quiz">0</div><div class="muted">–í–∏–∫—Ç–æ—Ä–∏–Ω–∞</div></div>
          <div class="counter"><div class="n" id="c-cheese">0</div><div class="muted">–°—ã—Ä</div></div>
          <div class="counter"><div class="n" id="c-pron">0</div><div class="muted">–ü—Ä–æ–∏–∑–Ω.</div></div>
        </div>
      </div>

      <div class="list grid">
        <div class="item"><div class="left"><span>üß†</span><div><div class="h3">–í–∏–∫—Ç–æ—Ä–∏–Ω–∞</div><div class="muted">–í—ã–±–µ—Ä–∏ –≤–µ—Ä–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥</div></div></div>
             <div class="right"><button class="btn primary" data-goto="quiz">–û—Ç–∫—Ä—ã—Ç—å ‚Üí</button></div></div>
        <div class="item"><div class="left"><span>üÉè</span><div><div class="h3">–ö–∞—Ä—Ç–æ—á–∫–∏</div><div class="muted">EN ‚áÑ RU. ¬´–ó–Ω–∞—é¬ª –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ –∏–∑—É—á–µ–Ω–Ω—ã–µ</div></div></div>
             <div class="right"><button class="btn primary" data-goto="cards">–û—Ç–∫—Ä—ã—Ç—å ‚Üí</button></div></div>
        <div class="item"><div class="left"><span>üéÆ</span><div><div class="h3">–ò–≥—Ä–∞</div><div class="muted">–°—ä–µ—à—å —Å—ã—Ä ‚Äî ¬´–±–∏–ø¬ª + —Å–ª–æ–≤–æ</div></div></div>
             <div class="right"><button class="btn primary" data-goto="game">–û—Ç–∫—Ä—ã—Ç—å ‚Üí</button></div></div>
        <div class="item"><div class="left"><span>üéôÔ∏è</span><div><div class="h3">–ü—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ</div><div class="muted">–°–∫–∞–∂–∏ —Å–ª–æ–≤–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ—Ö–æ–∂–µ</div></div></div>
             <div class="right"><button class="btn primary" data-goto="pron">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å ‚Üí</button></div></div>
      </div>
    </section>

    <!-- QUIZ -->
    <section id="view-quiz" class="view grid" aria-label="–í–∏–∫—Ç–æ—Ä–∏–Ω–∞">
      <div class="card">
        <div class="section-title">–í–∏–∫—Ç–æ—Ä–∏–Ω–∞ ‚Äî –≤—ã–±–µ—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥</div>
        <div class="word" id="q-word">cheese</div>
        <div class="quiz-opts" id="q-opts"></div>
        <div class="actions" style="margin-top:12px">
          <button class="btn" data-goto="menu">–ú–µ–Ω—é</button>
          <button class="btn primary" id="q-next">–î–∞–ª—å—à–µ</button>
        </div>
      </div>
    </section>

    <!-- CARDS -->
    <section id="view-cards" class="view grid" aria-label="–ö–∞—Ä—Ç–æ—á–∫–∏">
      <div class="card">
        <div class="section-title">–ö–∞—Ä—Ç–æ—á–∫–∏ ‚Äî –±—ã—Å—Ç—Ä–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</div>
        <div class="word" id="c-word">cheese</div>
        <div id="c-sub" class="muted" style="min-height:28px">–Ω–∞–∂–º–∏ ¬´–ü–æ–∫–∞–∑–∞—Ç—å RU¬ª</div>
        <div class="actions">
          <button class="btn" id="c-show">–ü–æ–∫–∞–∑–∞—Ç—å RU</button>
          <button class="btn" id="c-say">–û–∑–≤—É—á–∏—Ç—å</button>
          <button class="btn" id="c-know">–ó–Ω–∞—é</button>
          <button class="btn primary" id="c-next">–î–∞–ª—å—à–µ</button>
        </div>
        <div class="actions" style="margin-top:10px">
          <button class="btn" data-goto="menu">–ú–µ–Ω—é</button>
        </div>
      </div>
    </section>

    <!-- GAME -->
    <section id="view-game" class="view grid" aria-label="–ò–≥—Ä–∞">
      <div class="card">
        <div class="section-title">–ú—ã—à—å & –°—ã—Ä</div>
        <div class="actions" style="margin-bottom:8px"><button class="btn" id="g-restart">–†–µ—Å—Ç–∞—Ä—Ç</button> <button class="btn" data-goto="menu">–ú–µ–Ω—é</button></div>
        <div id="board"><canvas id="game" width="10" height="10"></canvas></div>
        <div class="hint">–°–≤–∞–π–ø–∞–π –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –¢–∞–ø ‚Äî –ø–æ–≤–µ—Ä–Ω—É—Ç—å –∫ —Å—ã—Ä—É. –°—ä–µ—à—å —Å—ã—Ä ‚Äî ¬´–±–∏–ø¬ª –∏ —Å–ª–æ–≤–æ.</div>
      </div>
    </section>

    <!-- PRONUNCIATION -->
    <section id="view-pron" class="view grid" aria-label="–ü—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ">
      <div class="card">
        <div class="section-title">–ü—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ ‚Ä¢ —Å–∫–∞–∂–∏ —Å–ª–æ–≤–æ –∫–∞–∫ –º–æ–∂–Ω–æ –±–ª–∏–∂–µ –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—É</div>
        <div class="word" id="p-word">cheese</div>
        <div class="muted" id="p-ru">—Å—ã—Ä</div>
        <div class="actions" style="margin-top:10px">
          <button class="btn" id="p-listen">–°–ª—É—à–∞—Ç—å</button>
          <button class="btn primary" id="p-say">–°–∫–∞–∑–∞—Ç—å (–±—Ä–∞—É–∑–µ—Ä)</button>
        </div>
        <div class="actions" style="margin-top:6px">
          <button class="btn" data-goto="menu">–ú–µ–Ω—é</button>
          <button class="btn" id="p-next">–î–∞–ª—å—à–µ</button>
        </div>
        <div class="grid" style="margin-top:10px">
          <div class="badge">–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: <span id="micState">—Å–ª—É—à–∞—é‚Ä¶</span></div>
          <div class="grid2">
            <input id="p-typed" class="btn round" placeholder="–§–æ–ª–ª–±—ç–∫: –Ω–∞–ø–µ—á–∞—Ç–∞–π –∞–Ω–≥–ª" />
            <button id="p-check" class="btn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
          </div>
          <div class="badge">–°–æ–≤–ø–∞–¥–µ–Ω–∏–µ: <span id="p-score">0%</span></div>
        </div>
      </div>
    </section>

  </main>

  <footer>v4.7 ‚Ä¢ Light/Dark ‚Ä¢ —Ç–∞—á-—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Ä¢ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</footer>
</div>

<script>
// ======= DATA =======
const WORDS = [
  ["cheese","—Å—ã—Ä"],["bread","—Ö–ª–µ–±"],["water","–≤–æ–¥–∞"],["write","–ø–∏—Å–∞—Ç—å"],["friend","–¥—Ä—É–≥"],
  ["child","—Ä–µ–±—ë–Ω–æ–∫"],["milk","–º–æ–ª–æ–∫–æ"],["computer","–∫–æ–º–ø—å—é—Ç–µ—Ä"],["direction","–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"],
  ["tea","—á–∞–π"],["right","–ø—Ä–∞–≤–æ"],["hotel","–æ—Ç–µ–ª—å"],["room","–∫–æ–º–Ω–∞—Ç–∞"],["help","–ø–æ–º–æ–≥–∞—Ç—å"],
  ["speak","–≥–æ–≤–æ—Ä–∏—Ç—å"],["left","–ª–µ–≤–æ"],["city","–≥–æ—Ä–æ–¥"],["ticket","–±–∏–ª–µ—Ç"],
];

const state = {
  day: 1,
  goal: 20,
  counts: {cards:0, quiz:0, cheese:0, pron:0},
  learned: new Set(JSON.parse(localStorage.getItem('mc_learned')||'[]')),
  theme: localStorage.getItem('mc_theme') || 'dark'
};

function save(){
  localStorage.setItem('mc_learned', JSON.stringify([...state.learned]));
  localStorage.setItem('mc_theme', state.theme);
  localStorage.setItem('mc_counts', JSON.stringify(state.counts));
}
(function restore(){
  const c = localStorage.getItem('mc_counts'); if(c){ try{ state.counts = {...state.counts, ...JSON.parse(c)} }catch(e){} }
  document.body.setAttribute('data-theme', state.theme);
})();

// ======= UTIL =======
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const rnd = (n)=>Math.floor(Math.random()*n);
const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=rnd(i+1);[a[i],a[j]]=[a[j],a[i]]} return a};

function chooseWord(){
  const idx = rnd(WORDS.length);
  return {en: WORDS[idx][0], ru: WORDS[idx][1], idx};
}

// ======= NAV =======
const VIEWS = {menu:'#view-menu', quiz:'#view-quiz', cards:'#view-cards', game:'#view-game', pron:'#view-pron'};
function go(name){
  for(const k in VIEWS) $(VIEWS[k]).classList.toggle('active', k===name);
  window.scrollTo({top:0, behavior:'instant'});
}
$$('[data-goto]').forEach(b=> b.addEventListener('click', e=>{ go(e.currentTarget.dataset.goto) }));

$('#themeBtn').addEventListener('click', ()=>{ state.theme = (state.theme==='light'?'dark':'light'); document.body.setAttribute('data-theme', state.theme); save(); });

// ======= MENU =======
function updateMenu(){
  $('#todayCount').textContent = state.day;
  const p = Math.min(360, ( (state.counts.cards+state.counts.quiz+state.counts.cheese+state.counts.pron) / Math.max(1,state.goal) ) * 360);
  $('#todayRing').style.setProperty('--p', p+'deg');
  $('#dailyGoal').textContent = state.goal;
  $('#c-cards').textContent = state.counts.cards;
  $('#c-quiz').textContent = state.counts.quiz;
  $('#c-cheese').textContent = state.counts.cheese;
  $('#c-pron').textContent = state.counts.pron;
}
updateMenu();

// ======= TTS & BEEP =======
let voices = [];
function refreshVoices(){
  voices = speechSynthesis.getVoices();
}
refreshVoices();
if (typeof speechSynthesis !== 'undefined') speechSynthesis.onvoiceschanged = refreshVoices;

function pickEnVoice(){
  const v = voices.find(v=> /^en(-|_)/i.test(v.lang) && /female|male|Google|Samantha|Daniel/i.test(v.name)) || voices.find(v=>/^en/i.test(v.lang)) || voices[0];
  return v;
}

function speak(text){
  if (!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 0.95; u.pitch = 1; u.volume = 1;
  const v = pickEnVoice(); if(v) u.voice = v;
  window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
}

// quick beep
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function beep(freq=880, time=0.08){
  const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
  o.type='square'; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination); g.gain.setValueAtTime(0.0001, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.3, audioCtx.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+time); o.start(); o.stop(audioCtx.currentTime+time);
}

// ======= QUIZ =======
let qCurrent = null; let qAnswered = false;
function makeQuiz(){
  qAnswered=false;
  const base = chooseWord();
  qCurrent = base;
  $('#q-word').textContent = base.en;
  const opts = new Set([base.ru]);
  while (opts.size<4){ opts.add( WORDS[rnd(WORDS.length)][1] ); }
  const arr = shuffle([...opts]);
  const box = $('#q-opts'); box.innerHTML='';
  arr.forEach(ru=>{
    const el = document.createElement('button'); el.className='opt btn'; el.textContent=ru; el.addEventListener('click',()=>quizAnswer(el, ru===base.ru)); box.appendChild(el);
  });
}
function quizAnswer(el, ok){
  if(qAnswered) return; qAnswered=true;
  el.classList.add(ok?'ok':'bad');
  if(ok){ state.counts.quiz++; save(); updateMenu(); speak(qCurrent.en); }
}
$('#q-next').addEventListener('click', makeQuiz);

// ======= CARDS =======
let cCurrent = chooseWord();
function showCard(){
  $('#c-word').textContent = cCurrent.en;
  $('#c-sub').textContent = '–Ω–∞–∂–º–∏ ¬´–ü–æ–∫–∞–∑–∞—Ç—å RU¬ª';
}
$('#c-show').addEventListener('click', ()=>{ $('#c-sub').textContent = cCurrent.ru; });
$('#c-say').addEventListener('click', ()=> speak(cCurrent.en));
$('#c-know').addEventListener('click', ()=>{ state.learned.add(cCurrent.en); state.counts.cards++; save(); updateMenu(); nextCard(); });
function nextCard(){ cCurrent = chooseWord(); showCard(); }
$('#c-next').addEventListener('click', nextCard);
showCard();

// ======= GAME =======
const g = $('#game'); const ctx = g.getContext('2d');
let grid=14, size=24, mouse={x:2,y:2,dir:'R'}, cheese={x:8,y:8};
function resizeCanvas(){
  const board = $('#board');
  const w = board.clientWidth - 4; // border
  size = Math.max(20, Math.floor(w / grid));
  g.width = grid*size; g.height = Math.min(board.clientHeight-4, grid*size);
  draw();
}
window.addEventListener('resize', resizeCanvas);

function draw(){
  ctx.clearRect(0,0,g.width,g.height);
  // grid bg
  ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--panel');
  ctx.fillRect(0,0,g.width,g.height);
  ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--ring');
  ctx.lineWidth=1; for(let i=0;i<=grid;i++){ ctx.beginPath(); ctx.moveTo(i*size,0); ctx.lineTo(i*size,g.height); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0,i*size); ctx.lineTo(g.width,i*size); ctx.stroke(); }
  // cheese
  ctx.font = (size*0.8)+'px Apple Color Emoji, Segoe UI Emoji'; ctx.textBaseline='top';
  ctx.fillText('üßÄ', cheese.x*size + size*0.1, cheese.y*size + size*0.05);
  // mouse
  ctx.fillText('üê≠', mouse.x*size + size*0.1, mouse.y*size + size*0.05);
}
function randFree(){ return {x:rnd(grid), y:rnd(grid)} }
function step(){
  const d = {L:[-1,0], R:[1,0], U:[0,-1], D:[0,1]}[mouse.dir];
  mouse.x = (mouse.x + d[0] + grid) % grid;
  mouse.y = (mouse.y + d[1] + grid) % grid;
  if(mouse.x===cheese.x && mouse.y===cheese.y){
    state.counts.cheese++; save(); updateMenu();
    beep(); speak(cCurrent.en); // speak current card word
    cheese = randFree();
  }
  draw();
}
let loop = setInterval(step, 420);
$('#g-restart').addEventListener('click', ()=>{ mouse={x:2,y:2,dir:'R'}; cheese = randFree(); draw(); });

// touch / swipe controls
let touchStart=null;
$('#board').addEventListener('touchstart', e=>{ touchStart = [...e.touches][0]; });
$('#board').addEventListener('touchend', e=>{ if(!touchStart) return; const t = touchStart; touchStart=null; const up=[...e.changedTouches][0]; const dx=up.clientX-t.clientX, dy=up.clientY-t.clientY; const ax=Math.abs(dx), ay=Math.abs(dy); if(Math.max(ax,ay)<24){ // tap -> rotate towards cheese
    const dx2 = cheese.x - mouse.x, dy2 = cheese.y - mouse.y; if(Math.abs(dx2)>Math.abs(dy2)) mouse.dir = dx2>0?'R':'L'; else mouse.dir = dy2>0?'D':'U'; return; }
  if(ax>ay) mouse.dir = dx>0?'R':'L'; else mouse.dir = dy>0?'D':'U'; });

resizeCanvas(); draw();

// ======= PRONUNCIATION =======
let pCurrent = chooseWord();
const Rec = window.SpeechRecognition || window.webkitSpeechRecognition; let rec=null; let recEnabled=false;
function setPword(){ $('#p-word').textContent = pCurrent.en; $('#p-ru').textContent = pCurrent.ru; $('#p-score').textContent='0%'; $('#p-typed').value=''; }
setPword();

function strSim(a,b){ // quick similarity 0..1
  a=a.toLowerCase().trim(); b=b.toLowerCase().trim(); if(!a||!b) return 0; if(a===b) return 1; const m = new Set(a); const n=new Set(b); let inter=0; m.forEach(ch=>{ if(n.has(ch)) inter++; }); return inter/Math.max(a.length,b.length);
}

$('#p-listen').addEventListener('click', ()=> speak(pCurrent.en));
$('#p-next').addEventListener('click', ()=>{ state.counts.pron++; save(); updateMenu(); pCurrent=chooseWord(); setPword(); });
$('#p-check').addEventListener('click', ()=>{ const s = strSim($('#p-typed').value, pCurrent.en); $('#p-score').textContent = Math.round(s*100)+'%'; });

// live speech recognition if available
if(Rec){
  rec = new Rec(); rec.lang='en-US'; rec.interimResults=false; rec.maxAlternatives=1;
  rec.onstart = ()=> $('#micState').textContent='—Å–ª—É—à–∞—é‚Ä¶';
  rec.onend = ()=> $('#micState').textContent='—Å—Ç–æ–ø';
  rec.onerror = ()=> $('#micState').textContent='–æ—à–∏–±–∫–∞';
  rec.onresult = (e)=>{ const said = e.results[0][0].transcript || ''; const s = strSim(said, pCurrent.en); $('#p-score').textContent = Math.round(s*100)+'%'; };
  recEnabled=true; $('#micState').textContent='–≥–æ—Ç–æ–≤';
} else {
  $('#micState').textContent='–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
}
$('#p-say').addEventListener('click', ()=>{ try{ rec && rec.start(); }catch(err){ /* ignore */ } });

// ===== INIT =====
makeQuiz();

// ensure CTA never falls under Telegram bar
const scrollPad = document.createElement('div'); scrollPad.style.height='4px'; document.body.appendChild(scrollPad);
</script>
</body>
</html>
