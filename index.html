<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Mouse & Cheese</title>
<style>
:root{
  --bg:#0b1220; --card:#111827; --text:#EAF1FF; --muted:#98A2B3;
  --primary:#3AB4FF; --accent:#9A6BFF; --ok:#22C55E;
  --chip:#1f2937; --ring:#8aa4ff40; --radius:16px; --gap:12px;
  --shadow:0 8px 24px rgba(0,0,0,.25);
  --danger:#ef4444;
}
:root[data-theme="light"]{
  --bg:#F6F8FB; --card:#FFFFFF; --text:#101828; --muted:#667085;
  --primary:#1769FF; --accent:#7B3AFD; --ok:#0EA35C;
  --chip:#EEF2F6; --ring:#1769ff22; --danger:#e11d48;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
a{color:inherit}
.hidden{display:none!important}
.safe-bottom{height:env(safe-area-inset-bottom)}

/* Top bar */
.topbar{position:sticky;top:0;z-index:10;background:linear-gradient(to bottom,rgba(0,0,0,.18),transparent),var(--bg);
  display:flex;align-items:center;gap:10px;padding:10px 12px 8px 12px;backdrop-filter:blur(8px)}
.brand{font:800 18px/1.1 system-ui;letter-spacing:.2px}
.topbar .sp{flex:1}
.btn{border-radius:12px;padding:10px 14px;background:var(--primary);color:#fff;border:0;cursor:pointer}
.btn.small{padding:8px 10px;font-size:12px}
.btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.15)}
:root[data-theme="light"] .btn.ghost{border-color:#E5E7EB}
.icon{width:18px;height:18px;vertical-align:-3px}

/* Views */
.view{max-width:980px;margin:0 auto;padding:12px}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow)}
.section{padding:16px 16px 14px}
.h1{font:800 28px/1.15 system-ui;margin:6px 4px 12px}
.h2{font:700 20px/1.2 system-ui;margin:0}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}

/* Menu grid */
.menu-grid{display:grid;gap:16px}
.tile{grid-column:1/-1}
@media(min-width:520px){.menu-grid{grid-template-columns:repeat(6,1fr)} .tile{grid-column:span 3}}
@media(min-width:920px){.menu-grid{grid-template-columns:repeat(12,1fr)} .tile{grid-column:span 4}}
.tile .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;min-width:240px}
.kpi .box{background:var(--chip);border-radius:12px;padding:10px;text-align:center;min-width:80px}
.kpi .big{font:800 22px/1.1 system-ui}
.chips{display:flex;gap:8px;flex-wrap:wrap;max-width:420px}
.chip{border-radius:999px;padding:6px 10px;font-size:12px;background:var(--chip);color:var(--muted)}

/* ring */
.ring{width:120px;height:120px}
.ring-svg text{fill:var(--text);font:800 10px/1 system-ui}
.ring-val{font-size:12px}

/* Cards / Quiz common */
.word-box{display:grid;gap:12px}
.word-en{font:800 44px/1.2 system-ui;letter-spacing:.4px}
.word-ru{color:var(--muted)}
.actions-row{display:flex;gap:10px;flex-wrap:wrap}
.actions-row .btn{flex:1;min-width:120px}

/* Game */
#gameWrap{display:grid;gap:12px}
#board{touch-action:none;user-select:none;display:block;margin:0 auto;background:
  repeating-linear-gradient(90deg,transparent 0,transparent 27px,var(--ring) 28px),
  repeating-linear-gradient(0deg,transparent 0,transparent 27px,var(--ring) 28px),
  var(--card);
  border-radius:10px;box-shadow:inset 0 0 0 1px var(--ring);
}
.game-hint{color:var(--muted);text-align:center}

/* Pronunciation */
.badge{display:inline-block;border-radius:999px;padding:6px 10px;background:var(--chip);color:var(--muted);font-size:12px}

/* Footer links */
.foot{opacity:.8;font-size:12px;margin:12px 4px;text-align:center;color:var(--muted)}
</style>
</head>
<body>

<header class="topbar">
  <div class="brand">üê≠ Mouse & Cheese</div>
  <div class="sp"></div>
  <button class="btn small ghost" id="themeBtn" title="–°–≤–µ—Ç–ª–∞—è/—Ç—ë–º–Ω–∞—è —Ç–µ–º–∞">–¢–µ–º–∞</button>
  <button class="btn small ghost" id="menuBtn">–ú–µ–Ω—é</button>
</header>

<!-- MENU -->
<section id="view-menu" class="view">
  <div class="h1">–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</div>
  <div class="menu-grid">
    <!-- Dashboard -->
    <div class="tile card section">
      <div class="row">
        <div>
          <div id="ringToday" class="ring"></div>
          <div class="chips" id="chipsLast" title="–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑—É—á–µ–Ω–Ω—ã–µ"></div>
        </div>
        <div class="kpi">
          <div class="box"><div class="big" id="kpiCards">0</div><div>–ö–∞—Ä—Ç–æ—á–∫–∏</div></div>
          <div class="box"><div class="big" id="kpiQuiz">0</div><div>–í–∏–∫—Ç–æ—Ä–∏–Ω–∞</div></div>
          <div class="box"><div class="big" id="kpiCheese">0</div><div>–°—ã—Ä</div></div>
          <div class="box"><div class="big" id="kpiPron">0</div><div>–ü—Ä–æ–∏–∑–Ω.</div></div>
        </div>
      </div>
    </div>

    <div class="tile card section">
      <div class="row"><h3 class="h2">üß† –í–∏–∫—Ç–æ—Ä–∏–Ω–∞</h3><button class="btn" onclick="go('quiz')">–û—Ç–∫—Ä—ã—Ç—å ‚Üí</button></div>
    </div>
    <div class="tile card section">
      <div class="row"><h3 class="h2">üÉè –ö–∞—Ä—Ç–æ—á–∫–∏</h3><button class="btn" onclick="go('cards')">–û—Ç–∫—Ä—ã—Ç—å ‚Üí</button></div>
    </div>
    <div class="tile card section">
      <div class="row"><h3 class="h2">üéÆ –ò–≥—Ä–∞</h3><button class="btn" onclick="go('game')">–û—Ç–∫—Ä—ã—Ç—å ‚Üí</button></div>
    </div>
    <div class="tile card section">
      <div class="row"><h3 class="h2">üéôÔ∏è –ü—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ</h3><button class="btn" onclick="go('pron')">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å ‚Üí</button></div>
    </div>
  </div>

  <div class="foot">v4.5 ¬∑ Light/Dark ¬∑ —Ç–∞—á‚Äë—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ¬∑ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</div>
  <div class="safe-bottom"></div>
</section>

<!-- CARDS -->
<section id="view-cards" class="view hidden">
  <div class="card section">
    <div class="h2">–ö–∞—Ä—Ç–æ—á–∫–∏</div>
    <div class="word-box">
      <div class="word-en" id="cardEN">cheese</div>
      <div class="word-ru" id="cardRU" hidden>—Å—ã—Ä</div>
      <div class="actions-row">
        <button class="btn ghost" onclick="cards.showRU()">–ü–æ–∫–∞–∑–∞—Ç—å RU</button>
        <button class="btn ghost" onclick="speak(current.en)">–û–∑–≤—É—á–∏—Ç—å</button>
        <button class="btn" onclick="cards.know()">–ó–Ω–∞—é</button>
        <button class="btn ghost" onclick="cards.next()">–î–∞–ª—å—à–µ</button>
      </div>
    </div>
  </div>
</section>

<!-- QUIZ -->
<section id="view-quiz" class="view hidden">
  <div class="card section">
    <div class="h2">–í–∏–∫—Ç–æ—Ä–∏–Ω–∞ ‚Äî –≤—ã–±–µ—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥</div>
    <div class="word-box">
      <div class="word-en" id="quizEN">write</div>
      <div class="actions-row" id="quizOptions"></div>
      <div id="quizStatus" class="badge hidden"></div>
    </div>
  </div>
</section>

<!-- GAME -->
<section id="view-game" class="view hidden">
  <div class="card section" id="gameWrap">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="h2">–ú—ã—à—å & –°—ã—Ä</div>
      <button class="btn small ghost" onclick="game.restart()">–†–µ—Å—Ç–∞—Ä—Ç</button>
    </div>
    <canvas id="board" width="392" height="336"></canvas>
    <div class="game-hint">–°–≤–∞–π–ø–∞–π –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –¢–∞–ø ‚Äî –ø–æ–≤–µ—Ä–Ω—É—Ç—å –∫ —Å—ã—Ä—É. –°—ä–µ—à—å —Å—ã—Ä ‚Äî ¬´–±–∏–ø¬ª –∏ —Å–ª–æ–≤–æ.</div>
    <div id="gameWord" class="badge hidden"></div>
  </div>
</section>

<!-- PRONUNCIATION -->
<section id="view-pron" class="view hidden">
  <div class="card section">
    <div class="h2">–ü—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ ‚Ä¢ —Å–∫–∞–∂–∏ —Å–ª–æ–≤–æ –∫–∞–∫ –º–æ–∂–Ω–æ –±–ª–∏–∂–µ –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—É</div>
    <div class="word-box">
      <div class="word-en" id="prEN">ticket</div>
      <div class="word-ru" id="prRU">–±–∏–ª–µ—Ç</div>
      <div class="actions-row">
        <button class="btn ghost" onclick="speak(current.en)">–°–ª—É—à–∞—Ç—å</button>
        <button class="btn" onclick="pron.say()">–°–∫–∞–∑–∞—Ç—å (–±—Ä–∞uz–µ—Ä)</button>
        <button class="btn ghost" onclick="pron.next()">–î–∞–ª—å—à–µ</button>
      </div>
      <div class="badge" id="prInfo">–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: <span id="micState">–æ—Ç–∫–ª—é—á—ë–Ω</span></div>
      <div class="actions-row" id="prFallback" style="margin-top:8px">
        <input id="prInput" placeholder="–§–æ–ª–ª–±—ç–∫: –Ω–∞–ø–µ—á–∞—Ç–∞–π –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ —Å–ª–æ–≤–æ" class="card" style="padding:10px;border-radius:10px;border:1px solid var(--ring);flex:1;background:transparent;color:var(--text)">
        <button class="btn ghost" onclick="pron.check()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
      </div>
      <div id="prMatch" class="badge hidden"></div>
    </div>
  </div>
</section>

<script>
/* ---------- DATA ---------- */
const WORDS = [
  {en:'cheese', ru:'—Å—ã—Ä'}, {en:'child', ru:'—Ä–µ–±—ë–Ω–æ–∫'}, {en:'milk', ru:'–º–æ–ª–æ–∫–æ'}, {en:'ticket', ru:'–±–∏–ª–µ—Ç'},
  {en:'luggage', ru:'–±–∞–≥–∞–∂'}, {en:'bread', ru:'—Ö–ª–µ–±'}, {en:'friend', ru:'–¥—Ä—É–≥'}, {en:'computer', ru:'–∫–æ–º–ø—å—é—Ç–µ—Ä'},
  {en:'direction', ru:'–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'}, {en:'tea', ru:'—á–∞–π'}, {en:'right', ru:'–ø—Ä–∞–≤–æ'}, {en:'room', ru:'–∫–æ–º–Ω–∞—Ç–∞'},
  {en:'help', ru:'–ø–æ–º–æ–≥–∞—Ç—å'}, {en:'left', ru:'–ª–µ–≤–æ'}, {en:'write', ru:'–ø–∏—Å–∞—Ç—å'}, {en:'water', ru:'–≤–æ–¥–∞'},
  {en:'speak', ru:'–≥–æ–≤–æ—Ä–∏—Ç—å'}, {en:'read', ru:'—á–∏—Ç–∞—Ç—å'}
];
let current = WORDS[0];

/* ---------- STATE ---------- */
const ST_KEY='mnc-state-v45';
let state = JSON.parse(localStorage.getItem(ST_KEY) || 'null') || {
  date: new Date().toISOString().slice(0,10),
  today: 0,
  stats: {cards:0, quiz:0, cheese:0, pron:0},
  lastLearned: [],
  known: {}
};
function save(){ localStorage.setItem(ST_KEY, JSON.stringify(state)); }
function bumpToday(n=1){
  const d = new Date().toISOString().slice(0,10);
  if(state.date!==d){state.date=d;state.today=0;}
  state.today += n; save(); fillDashboard();
}

/* ---------- THEME ---------- */
(function(){
  const key='mnc-theme';
  const prefersLight = matchMedia('(prefers-color-scheme: light)').matches;
  const saved = localStorage.getItem(key) || (prefersLight?'light':'dark');
  document.documentElement.setAttribute('data-theme', saved);
  document.getElementById('themeBtn').onclick=()=>{
    const cur=document.documentElement.getAttribute('data-theme');
    const next=cur==='light'?'dark':'light';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem(key,next);
  };
})();

/* ---------- NAV ---------- */
const views = ['menu','cards','quiz','game','pron'];
function go(name){
  views.forEach(v=>document.getElementById('view-'+v).classList.toggle('hidden', v!==name));
  // ensure menu button present
  document.getElementById('menuBtn').onclick=()=>go('menu');
}
document.getElementById('menuBtn').onclick=()=>go('menu');
go('menu');

/* ---------- DASHBOARD ---------- */
function renderRing(el, value, goal=20){
  const pct = Math.max(0, Math.min(100, Math.round(value/goal*100)));
  el.innerHTML = `
  <svg viewBox="0 0 36 36" class="ring-svg" width="120" height="120" aria-label="–°–µ–≥–æ–¥–Ω—è">
    <defs><linearGradient id="grad" x1="1" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="var(--primary)"/>
      <stop offset="100%" stop-color="var(--accent)"/>
    </linearGradient></defs>
    <circle cx="18" cy="18" r="15.5" stroke="var(--ring)" stroke-width="3" fill="none"/>
    <circle cx="18" cy="18" r="15.5" stroke="url(#grad)" stroke-width="3" fill="none"
      stroke-dasharray="${pct} ${100-pct}" stroke-linecap="round" transform="rotate(-90 18 18)"/>
    <text x="18" y="15" text-anchor="middle">–°–µ–≥–æ–¥–Ω—è</text>
    <text x="18" y="23" text-anchor="middle" class="ring-val">${value}</text>
  </svg>`;
}
function fillDashboard(){
  renderRing(document.getElementById('ringToday'), state.today||0, 20);
  document.getElementById('kpiCards').textContent = state.stats.cards||0;
  document.getElementById('kpiQuiz').textContent = state.stats.quiz||0;
  document.getElementById('kpiCheese').textContent = state.stats.cheese||0;
  document.getElementById('kpiPron').textContent = state.stats.pron||0;
  const chips=document.getElementById('chipsLast');
  chips.innerHTML=''; (state.lastLearned||[]).slice(-10).reverse().forEach(w=>{
    const s=document.createElement('span'); s.className='chip'; s.textContent=w; chips.appendChild(s);
  });
}
fillDashboard();

/* ---------- UTILS ---------- */
function rnd(n){return Math.floor(Math.random()*n)}
function sample(arr){return arr[rnd(arr.length)]}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a;}
function beep(ms=120, freq=880){
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type='sine'; o.frequency.value=freq; o.start();
    g.gain.setValueAtTime(.2, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+ms/1000);
    o.stop(ctx.currentTime+ms/1000+0.02);
  }catch(e){/* ignore */}
}
function similarity(a,b){ // 0..1
  a=a.toLowerCase().trim(); b=b.toLowerCase().trim();
  if(!a||!b) return 0;
  const d=[];
  for(let i=0;i<=a.length;i++){d[i]=[i]}
  for(let j=0;j<=b.length;j++){d[0][j]=j}
  for(let i=1;i<=a.length;i++){
    for(let j=1;j<=b.length;j++){
      d[i][j]=Math.min(
        d[i-1][j]+1,
        d[i][j-1]+1,
        d[i-1][j-1] + (a[i-1]==b[j-1]?0:1)
      )
    }
  }
  const dist=d[a.length][b.length];
  return 1 - dist/Math.max(a.length,b.length);
}

/* ---------- SPEAK ---------- */
let VOICES=[];
function loadVoices(){
  VOICES = speechSynthesis.getVoices();
  if(!VOICES.length){ setTimeout(loadVoices, 250); }
}
if('speechSynthesis' in window){
  speechSynthesis.onvoiceschanged = loadVoices;
  loadVoices();
}
function speak(text, lang='en-US'){
  if(!('speechSynthesis' in window)) return;
  const u=new SpeechSynthesisUtterance(text);
  u.lang=lang;
  const v = VOICES.find(v=>/en/i.test(v.lang)&&/google|samantha|arthur|microsoft|zira/i.test(v.name)) || VOICES.find(v=>/en/i.test(v.lang));
  if(v) u.voice=v;
  u.rate=1; u.pitch=1;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* ---------- CARDS ---------- */
const cards = {
  idx: 0,
  next(){
    this.idx = (this.idx + 1) % WORDS.length;
    current = WORDS[this.idx];
    document.getElementById('cardEN').textContent=current.en;
    const ru=document.getElementById('cardRU'); ru.textContent=current.ru; ru.hidden=true;
  },
  showRU(){ document.getElementById('cardRU').hidden=false; },
  know(){
    state.known[current.en]=true;
    if(!state.lastLearned.includes(current.en)) state.lastLearned.push(current.en);
    state.stats.cards++; bumpToday(); save(); fillDashboard();
    this.next();
  }
};
cards.next();

/* ---------- QUIZ ---------- */
function renderQuiz(){
  const elEN=document.getElementById('quizEN');
  current = sample(WORDS);
  elEN.textContent=current.en;
  const opts = [current, ...shuffle(WORDS.filter(w=>w.en!==current.en)).slice(0,3)];
  shuffle(opts);
  const box=document.getElementById('quizOptions'); box.innerHTML='';
  const status=document.getElementById('quizStatus'); status.classList.add('hidden');
  opts.forEach(o=>{
    const b=document.createElement('button');
    b.className='btn ghost'; b.textContent=o.ru;
    b.onclick=()=>{
      const good = o.ru===current.ru;
      if(good){
        b.className='btn';
        status.textContent='–í–µ—Ä–Ω–æ ‚úÖ'; status.classList.remove('hidden');
        state.stats.quiz++; bumpToday(); save(); fillDashboard(); beep(60,1200);
        setTimeout(renderQuiz, 600);
      }else{
        b.classList.add('danger');
        b.style.borderColor='var(--danger)';
        status.textContent='–ù–µ–≤–µ—Ä–Ω–æ ‚ùå'; status.classList.remove('hidden');
        beep(100,200);
      }
    };
    box.appendChild(b);
  });
}
renderQuiz();

/* ---------- GAME ---------- */
const game = (function(){
  const board=document.getElementById('board');
  const ctx=board.getContext('2d');
  let CELL=28, GRID_W=14, GRID_H=12;
  board.width=GRID_W*CELL; board.height=GRID_H*CELL;

  const opposite = {r:'l', l:'r', u:'d', d:'u'};
  const stateG = {
    mouse:{x:5,y:5,dir:'r'},
    cheese:{x:9,y:7},
    running:false, timer:null
  };
  function setDir(d){ if(opposite[stateG.mouse.dir]!==d) stateG.mouse.dir=d; }
  function randCheese(){
    stateG.cheese.x = rnd(GRID_W); stateG.cheese.y=rnd(GRID_H);
    if(stateG.cheese.x===stateG.mouse.x && stateG.cheese.y===stateG.mouse.y) randCheese();
  }
  function drawEmoji(e, x, y){
    ctx.font = CELL+'px "Apple Color Emoji","Segoe UI Emoji",system-ui';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(e, x*CELL+CELL/2, y*CELL+CELL/2);
  }
  function draw(){
    ctx.clearRect(0,0,board.width,board.height);
    drawEmoji('üßÄ', stateG.cheese.x, stateG.cheese.y);
    drawEmoji('üê≠', stateG.mouse.x, stateG.mouse.y);
  }
  function step(){
    const m=stateG.mouse;
    if(m.dir==='r') m.x=(m.x+1)%GRID_W;
    if(m.dir==='l') m.x=(m.x-1+GRID_W)%GRID_W;
    if(m.dir==='u') m.y=(m.y-1+GRID_H)%GRID_H;
    if(m.dir==='d') m.y=(m.y+1)%GRID_H;
    if(m.x===stateG.cheese.x && m.y===stateG.cheese.y){
      beep(80,1000);
      showGameWord();
      state.stats.cheese++; bumpToday(); save(); fillDashboard();
      randCheese();
    }
    draw();
  }
  function showGameWord(){
    const gW=document.getElementById('gameWord');
    const w=sample(WORDS);
    gW.textContent = w.en+' ‚Äî '+w.ru;
    gW.classList.remove('hidden');
    setTimeout(()=>gW.classList.add('hidden'),1500);
  }
  // gestures
  let t0=null;
  board.addEventListener('touchstart',e=>{
    const t=e.changedTouches[0]; t0={x:t.clientX,y:t.clientY,time:Date.now()};
  },{passive:true});
  board.addEventListener('touchend',e=>{
    if(!t0) return; const t=e.changedTouches[0];
    const dx=t.clientX-t0.x, dy=t.clientY-t0.y;
    const dist=Math.hypot(dx,dy);
    if(dist<18){
      // tap ‚Äî –ø–æ–≤–µ—Ä–Ω—É—Ç—å –∫ —Å—ã—Ä—É
      const vx = stateG.cheese.x - stateG.mouse.x, vy = stateG.cheese.y - stateG.mouse.y;
      setDir(Math.abs(vx)>Math.abs(vy)? (vx>0?'r':'l') : (vy>0?'d':'u'));
    }else{
      setDir(Math.abs(dx)>Math.abs(dy)? (dx>0?'r':'l') : (dy>0?'d':'u'));
    }
    t0=null;
  });
  function start(){
    if(stateG.timer) clearInterval(stateG.timer);
    stateG.timer=setInterval(step, 220);
    stateG.running=true; draw();
  }
  function restart(){
    stateG.mouse={x:5,y:5,dir:'r'}; randCheese(); start();
  }
  restart();
  return {restart};
})();

/* ---------- PRONUNCIATION ---------- */
const pron=(function(){
  const en=document.getElementById('prEN'), ru=document.getElementById('prRU');
  const micState=document.getElementById('micState');
  const matchEl=document.getElementById('prMatch');
  let idx=0;
  function next(){ idx=(idx+1)%WORDS.length; current=WORDS[idx]; en.textContent=current.en; ru.textContent=current.ru; }
  next(); // init position at 1st call
  next = next.bind(this); // keep function
  function setMic(state){ micState.textContent=state; }
  function say(){
    if(!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)){ setMic('–Ω–µ—Ç API'); return; }
    const C = window.SpeechRecognition || window.webkitSpeechRecognition;
    const r = new C(); r.lang='en-US'; r.interimResults=false; r.maxAlternatives=1;
    setMic('–æ–∂–∏–¥–∞–Ω–∏–µ‚Ä¶');
    r.onstart=()=>setMic('—Å–ª—É—à–∞—é‚Ä¶');
    r.onerror=()=>setMic('–æ—à–∏–±–∫–∞');
    r.onend=()=>{/* keep state */};
    r.onresult=(e)=>{
      const text = (e.results[0][0].transcript||'').trim();
      const s = similarity(text, current.en);
      matchEl.textContent = `–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: ${text} ‚Ä¢ –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ: ${Math.round(s*100)}%`;
      matchEl.classList.remove('hidden');
      state.stats.pron++; bumpToday(); save(); fillDashboard();
    };
    r.start();
  }
  function check(){
    const val=(document.getElementById('prInput').value||'').trim();
    const s = similarity(val, current.en);
    matchEl.textContent = `–°–æ–≤–ø–∞–¥–µ–Ω–∏–µ: ${Math.round(s*100)}%`;
    matchEl.classList.remove('hidden');
  }
  return {next, say, check};
})();

/* ---------- INIT ---------- */
// initial current word for sections
current = WORDS[0];
document.getElementById('cardEN').textContent=current.en;
document.getElementById('cardRU').textContent=current.ru;
document.getElementById('quizEN').textContent=current.en;
document.getElementById('prEN').textContent=current.en; document.getElementById('prRU').textContent=current.ru;

</script>
</body>
</html>
